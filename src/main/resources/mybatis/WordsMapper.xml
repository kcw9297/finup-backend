<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="app.finup.layer.domain.words.mapper.WordsMapper">
    <select id="search" resultType="WordsRow">
        SELECT
        w.term_id     AS termId,
        w.name        AS `name`,
        w.description AS `description`
        FROM words w
        WHERE 1 = 1
        <if test="filter neq null and keyword neq null and keyword neq ''">
            <choose>
                <when test="filter eq 'name'">
                    AND w.name LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="filter eq 'description'">
                    AND w.description LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="filter eq 'nameDescription'">
                    AND (
                    w.name LIKE CONCAT('%', #{keyword}, '%')
                    OR w.description LIKE CONCAT('%', #{keyword}, '%')
                    )
                </when>
            </choose>
        </if>

        ORDER BY
        <trim suffixOverrides=",">
            <choose>
                <when test="order neq null and order neq ''">
                    <choose>
                        <!-- 가나다순 -->
                        <when test="order eq 'name_asc'">
                            w.name ASC,
                        </when>

                        <!-- 가나다 역순 -->
                        <when test="order eq 'name_desc'">
                            w.name DESC,
                        </when>

                        <!-- 용어 짧은 순 -->
                        <when test="order eq 'name_length_asc'">
                            LENGTH(w.name) ASC,
                        </when>

                        <!-- fallback -->
                        <otherwise>
                            w.name ASC,
                        </otherwise>
                    </choose>
                </when>

                <!-- order 파라미터 자체가 없을 때 -->
                <otherwise>
                    w.name ASC,
                </otherwise>
            </choose>
        </trim>


        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countBySearch" resultType="int">
        SELECT COUNT(*)
        FROM words w
        WHERE 1 = 1
        <if test="filter neq null and keyword neq null and keyword neq ''">
            <choose>
                <when test="filter eq 'name'">
                    AND w.name LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="filter eq 'description'">
                    AND w.description LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="filter eq 'nameDescription'">
                    AND (
                    w.name LIKE CONCAT('%', #{keyword}, '%')
                    OR w.description LIKE CONCAT('%', #{keyword}, '%')
                    )
                </when>
            </choose>
        </if>
    </select>
</mapper>